name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version'
        required: true
        type: string

jobs:
  bump:
    name: Bump version
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.out.outputs.sha }}
      version: ${{ steps.out.outputs.version }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Set Git username
        run: |-
          git config --global user.name "Release"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Update word snapshot
        run: pnpm update-snapshot

      - name: Commit and push if it changed
        run: |-
          git add -A
          timestamp=$(date -u)
          git commit -m "chore: Update word snapshot (${timestamp})" || exit 0
          git push

      - name: Bump version
        run: pnpm release-it --ci -i ${{ inputs.version }} -VV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output SHA + version
        id: out
        run: |
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "version=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

  build_macos:
    name: Build Safari assets
    runs-on: macos-latest
    needs: bump

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.bump.outputs.sha }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup node
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Build extension code
        run: |-
          pnpm install --frozen-lockfile
          pnpm build:safari

      - name: Install signing certificate and profile
        env:
          CERT_BASE64: ${{ secrets.APP_STORE_CERT_BASE64 }}
          MAC_INSTALLER_CERT_BASE64: ${{ secrets.MAC_INSTALLER_CERT_BASE64 }}
          MAC_INSTALLER_CERT_PASSWORD: ${{ secrets.MAC_INSTALLER_CERT_PASSWORD }}
          P12_PASSWORD: ${{ secrets.APP_STORE_CERT_PASSWORD }}
          PROFILE_IOS: ${{ secrets.IOS_PROFILE_BASE64 }}
          PROFILE_IOS_EXT: ${{ secrets.IOS_EXT_PROFILE_BASE64 }}
          PROFILE_MAC: ${{ secrets.MAC_PROFILE_BASE64 }}
          PROFILE_MAC_EXT: ${{ secrets.MAC_EXT_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Save the cert and profiles to temp files
          echo -n "$CERT_BASE64" | base64 --decode > cert.p12
          echo -n "$MAC_INSTALLER_CERT_BASE64" | base64 --decode > mac-installer.p12
          echo -n "$PROFILE_IOS" | base64 --decode > ios.mobileprovision
          echo -n "$PROFILE_IOS_EXT" | base64 --decode > ios-ext.mobileprovision
          echo -n "$PROFILE_MAC" | base64 --decode > mac.provisionprofile
          echo -n "$PROFILE_MAC_EXT" | base64 --decode > mac-ext.provisionprofile

          # Create a temporary keychain and import the .p12 certificate
          security delete-keychain build.keychain-db 2>/dev/null || true
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain-db
          security import cert.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k build.keychain-db
          security import mac-installer.p12 -P "$MAC_INSTALLER_CERT_PASSWORD" -A -t cert -f pkcs12 -k build.keychain-db
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" build.keychain-db
          security list-keychain -d user -s build.keychain-db

          # Install provisioning profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          cp ios-ext.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          cp mac.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/
          cp mac-ext.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build iOS app
        run: |
          xcodebuild archive \
            -project "xcode13/10ten Japanese Reader.xcodeproj" \
            -scheme "10ten Japanese Reader (iOS)" \
            -configuration Release \
            -archivePath $GITHUB_WORKSPACE/build/10ten-iOS.xcarchive \
            -destination 'generic/platform=iOS'

      - name: Build Mac app
        run: |
          xcodebuild archive \
            -project "xcode13/10ten Japanese Reader.xcodeproj" \
            -scheme "10ten Japanese Reader (macOS)" \
            -configuration Release \
            -archivePath $GITHUB_WORKSPACE/build/10ten-mac.xcarchive

      - name: Export iOS app package
        run: |
          xcodebuild -exportArchive \
            -archivePath $GITHUB_WORKSPACE/build/10ten-iOS.xcarchive \
            -exportOptionsPlist "xcode13/ExportOptions-iOS.plist" \
            -exportPath $GITHUB_WORKSPACE/build

      - name: Export Mac app package
        run: |
          xcodebuild -exportArchive \
            -archivePath $GITHUB_WORKSPACE/build/10ten-mac.xcarchive \
            -exportOptionsPlist "xcode13/ExportOptions-Mac.plist" \
            -exportPath $GITHUB_WORKSPACE/build

      - name: Upload packages
        uses: actions/upload-artifact@v6
        with:
          name: mac-packages
          path: |
            ${{ github.workspace }}/build/*.ipa
            ${{ github.workspace }}/build/*.pkg
          if-no-files-found: error

      - name: Cleanup signing material
        if: always()
        shell: bash
        run: |
          set +e

          # Remove temp files from workspace
          rm -f cert.p12 mac-installer.p12 \
            ios.mobileprovision ios-ext.mobileprovision \
            mac.provisionprofile mac-ext.provisionprofile

          # Remove installed provisioning profiles
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/ios.mobileprovision
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/ios-ext.mobileprovision
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/mac.provisionprofile
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/mac-ext.provisionprofile

          # Remove temporary keychain
          security delete-keychain build.keychain-db || true

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: [bump, build_macos]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.bump.outputs.sha }}
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Set Git username
        run: |-
          git config --global user.name "Release"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Build assets
        run: |
          pnpm install --frozen-lockfile
          scripts/build-assets.sh
        env:
          BUGSNAG_API_KEY: ${{ secrets.BUGSNAG_API_KEY }}

      - uses: actions/download-artifact@v7
        with:
          name: mac-packages
          path: release-assets

      - name: Tag
        run: |
          git tag -a "v${{ needs.bump.outputs.version }}" -m "Release v${{ needs.bump.outputs.version }}"
          git push origin "v${{ needs.bump.outputs.version }}"

      - name: Create draft release + upload assets
        run: |
          node ./scripts/release-notes.js "${{ needs.bump.outputs.version }}" > release-notes.md
          gh release create "v${{ needs.bump.outputs.version }}" \
            --draft \
            --verify-tag \
            --title "Release ${{ needs.bump.outputs.version }}" \
            --notes-file release-notes.md \
            release-assets/*
        # TODO: See if `gh release create` returns a URL to the created release
        # and, if so, output it to the step summary so we can find it later,
        #
        # e.g.
        #
        #   echo 'Draft release: ${releaseUrl}' >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
